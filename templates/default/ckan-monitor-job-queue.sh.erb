#!/bin/sh

LOG_FILE=/var/log/ckan/ckan-worker-queue.log
echo "CKAN job queue at $(date):" >> $LOG_FILE
TASK_COUNT=$(/usr/lib/ckan/default/bin/paster --plugin=ckan jobs list -c /etc/ckan/default/production.ini 2>/dev/null | tee -a $LOG_FILE | wc -l)
echo "Total: $TASK_COUNT job(s)" >> $LOG_FILE
aws cloudwatch put-metric-data --region <%= node['datashades']['region'] %> --namespace CKAN --dimensions Application=<%= node['datashades']['app_id'] %>,Environment=<%= node['datashades']['version'] %> --metric-name job_queue_size --value $TASK_COUNT
