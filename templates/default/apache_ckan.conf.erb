<VirtualHost 127.0.0.1:8000>
    ServerName <%= @app_url %>
    ServerAlias www.<%= @app_url %>
    <% @domains.each do |domain| %>
    ServerAlias <%= domain%>
    <% end %>

    RewriteEngine on
    WSGIScriptAlias <%= node['datashades']['ckan_web']['endpoint'] %> /etc/ckan/default/apache.wsgi

    # Pass authorization info on (needed for rest api).
    WSGIPassAuthorization On

    # Deploy as a daemon (avoids conflicts between CKAN instances).
    WSGIDaemonProcess ckan_default display-name=ckan_default processes=2 threads=15

    WSGIProcessGroup ckan_default

    ErrorLog /var/log/httpd/<%= node['datashades']['sitename'] %>/<%= @app_name %>_error.log

    # Rewrite to remove locale

    RewriteCond %{REQUEST_URI} ^/(a[fmrsz]|ar_(AE|BH|DZ|EG|IQ|JO|KW|LB|LY|MA|OM|QA|SA|SY|TN|YE)|az_AZ|b[egnos]|c[asy]|cs_CZ|d[aev]|da_DK|de_(AT|CH|DE|LI|LU)|e[lnstu]|en_(AU|BZ|CA|CB|GB|IE|IN|JM|NZ|PH|TT|US|ZA)|es_(AR|BO|C[LOR]|DO|EC|ES|GT|HN|MX|NI|P[AERY]|SV|UY|VE)|f[aior]|fa_IR|fr_(BE|CA|CH|FR|LU)|g[dlnu]|gd_IE|h[eiruy]|i[dst]|it_CH|it_IT|ja|k[akmnos]|ko_KR|l[aotv]|m[iklnrsty]|mn_MN|ms_BN|ms_MY|n[elo]|nl_BE|nl_NL|no_NO|or|p[alt]|pt_BR|pt_PT|r[mou]|ro_MO|ru_MO|s[abdikloqrvw]|sr_Latn|sr_SP|sv_FI|sv_SE|t[aeghklnrst]|u[krz]|uk_UA|uz_UZ|vi|xh|yi|zh|zh_(CN|HK|MO|SG|TW)|zu)|/(.*) [NC]
    RewriteRule / "/%2" [R]

    # API calls with significant side effects should not respect auth_tkt cookies, they should require the API key.
    <Location ~ /api/(?!storage|action/(package_resource_reorder|resource_view_reorder|[-_a-zA-Z0-9]*follow)|([12]/)?util/[a-z]+/(format_)?autocomplete) >
        RequestHeader unset Cookie
    </Location>

    # redirect 'group' URLs to organisations
    RewriteCond %{REQUEST_URI} /group/(aboriginal-and-torres-strait-islander-and-multicultural-affairs|agriculture-fisheries-and-forestry|communities-child-safety-and-disability-services|crime-and-misconduct-commission-queensland|education-training-and-employment|energy-and-water-supply|environment-and-heritage-protection|housing-and-public-works|justice-and-attorney-general|local-government-community-recovery-and-resilience|national-parks-recreation-sport-and-racing|natural-resources-and-mines|police|premier-and-cabinet|public-safety-business-agency|queensland-fire-and-emergency-services|queensland-health|science-information-technology-innovation-and-the-arts|state-development-infrastructure-and-planning|tourism-major-events-small-business-and-the-commonwealth-games|transport-and-main-roads|treasury-and-trade)
    RewriteRule /group/(.+) /organization/$1 [R]

    # MoG changes
    Redirect /organization/aboriginal-and-torres-strait-islander-and-multicultural-affairs /organization/aboriginal-and-torres-strait-islander-partnerships
    Redirect /organization/agriculture-fisheries-and-forestry /organization/agriculture-and-fisheries
    Redirect /organization/education-and-employment /organization/education-and-training
    Redirect /organization/local-government-community-recovery-and-resilience /organization/infrastructure-local-government-and-planning
    Redirect /organization/national-parks-recreation-sport-and-racing /organization/national-parks-sport-and-racing
    Redirect /organization/treasury-and-trade /organization/treasury
    Redirect /organization/science-information-technology-innovation-and-the-arts /organization/science-information-technology-and-innovation
    Redirect /organization/state-development-infrastructure-and-planning /organization/state-development

    Header always set Strict-Transport-Security "max-age=31536000"
    Header always edit Set-Cookie ^(.*)$ $1;HttpOnly;Secure

    <IfModule mod_remoteip.c>
        # nginx
        RemoteIPInternalProxy 127.0.0.1
        # ELB: VPC internal subnet
        RemoteIPTrustedProxy 172.31.0.0/16
        RemoteIPHeader X-Forwarded-For
    </IfModule>
    LogFormat "%a %{X-Forwarded-For}i %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined_proxied
    CustomLog /var/log/httpd/<%= node['datashades']['sitename'] %>/<%= @app_name %>_custom.log combined_proxied
</VirtualHost>
